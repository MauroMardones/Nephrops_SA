#SPICT for FU30
#Version SPiCT 1.3.8 for WGBIE2024
##Al cambiar la version de R hay que instalar de nuevo TMB y seguir las siguientes lineas de codigo##
install.packages("TMB", type="source")
write('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', file = "~/.Renviron", append = TRUE)
Sys.which("make")
C:\\rtools40\\usr\\bin\\make.exe
install.packages("jsonlite", type = "source")


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Charge library
```{r,warning=FALSE,message=FALSE}
#remotes::install_github("tokami/spict/spict", ref="fix130")
library(remotes)
remotes::install_github("DTUAqua/spict/spict")  
library(spict)
library(readxl)
library(icesAdvice)
```

Set Work Directory and Load Data

```{r}
setwd("D:/WGBIE/WGBIE 2024/SPiCT_FU30")

set.seed(1234)

data <- inputdata_spict_NEPSUR

head(data)
str(data)
summary(data)

C_nep <- data.frame(obsC = data$catch, timeC = data$Year)

I_Spr <- data.frame(obsI = c(data$arsaspr), timeI = data$Year + 0.25)
I_Isu <- data.frame(obsI = c(data$isunep), timeI = data$Year + 0.5)

```

# Run 1: CATCH SERIES FROM 1994 TO 2023. Using two abundance indices: ISUNEPCA TV survey (2015-2023), ARSA Spring Survey (1993-2023).Default priors. 

Create the inp object for the model
```{r}
ind=which(C_nep$timeC==1994)
ind2=which(C_nep$timeC==2023)

inp1 <- list(timeC = C_nep$timeC[ind:ind2], obsC = C_nep$obsC[ind:ind2],
             timeI = list(I_Isu$timeI, I_Spr$timeI),
             obsI = list(I_Isu$obsI, I_Spr$obsI))
inp1=check.inp(inp1)
```

Obs, this needs to be set BEFORE calling check.inp

```{r}
inp1$dteuler=1/16 ## Obs, this needs to be set BEFORE calling check.inp
inp1=check.inp(inp1)
inp1$dtc

check.inp(inp1)
```

Plot the input data

```{r}
plotspict.data(inp1) #color of individual points shows when the observation was made
dev.print(pdf, "./Results/inputdata.pdf")
```

```{r}
plotspict.ci(inp1)
dev.print(pdf, "./Results/advanced.pdf")
```

A guess for MSY
```{r}
guess.m(inp1)
```

Fit the model:
```{r}
res1 <- fit.spict(inp1)
```

Summary Results:
```{r}
capture.output(summary(res1))

```

```{r}
plot(res1,CI = 0.9)
dev.print(pdf, "./Results/fit.pdf")
```

**Checklist for the acceptance of a SPiCT assessment**

#1. The assessment converged  equals 0
```{r}
res1$opt$convergence 
```
#2. All variance parameters of the model parameters are finite should be TRUE
```{r}
all(is.finite(res1$sd))  
```
#3. No violation of model assumptions based on one-step-ahead residuals (bias, auto-correlation, normality)
```{r}
r1 <- calc.osa.resid(res1)
plotspict.diagnostic(r1)
dev.print(pdf, "./Results/diagnosis.pdf")
```
#4. Consistent patterns in the retrospective analysis
```{r}
r1<- fit.spict(inp1)
rep1=retro(r1, nretroyear=5)
plotspict.retro(rep1)
dev.print(pdf, "./Results/retro.pdf")
```
#5. Realistic production curve (0.1-0.9)
```{r}
calc.bmsyk(res1)
plotspict.production(res1)
dev.print(pdf, "./Results/production.pdf")
```
#6. Sensitivity to Initial values. They do not influence the parameter estimates
```{r}
fit <- check.ini(res1)
res1$check.ini$resmat
```

```{r}
set.seed(1234)
a=check.ini(inp1, ntrials=30,verbose = FALSE)
a$check.ini$resmat
```

#7. High assessment uncertainty can indicate a lack of contrast in the input data or violation of
#the ecological model assumptions. Confidence intervals for B/BMSY and F/BSMY should not span more
#than 1 order of magnitude. UNCERTAINTY (<=1).

```{r}
calc.om(res1)
```

```{r}
fit=res1
get.par("logBmBmsy", fit, exp=TRUE, CI = 0.9)
get.par("logFmFmsy", fit, exp=TRUE, CI = 0.9)
```

I also compute AIC value:
  
```{r}
get.AIC(res1)
```

